<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Structuring your Ansible Roles :: Le Tour De Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Introduction Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.
Group_Vars For my set up, group_vars, is structured like the following:
/ansible/group_vars └── all ├── docker.yml ├── roles │ ├── arrs.yml │ ├── blog.yml │ ├── comps.yml │ ├── dns.yml │ ├── gitea.yml │ ├── mariadb.yml │ ├── metrics.yml │ ├── plex.yml │ ├── postgres.yml │ ├── proxy.yml │ ├── torrents.yml │ ├── unifi.yml │ ├── usenet.yml │ ├── utilities.yml │ ├── vpn.yml │ └── wordpress.yml ├── traefik.yml └── vault.yml The docker.yml file contains general docker variables, such as puid/pgid and docker network information The traefik.yml file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task) The vault.yml file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information. The remaining variables are contained in the group_vars/all/roles folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/roles/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="http://localhost:1313/terminal.css">




<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Structuring your Ansible Roles">
<meta property="og:description" content=" Introduction Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.
Group_Vars For my set up, group_vars, is structured like the following:
/ansible/group_vars └── all ├── docker.yml ├── roles │ ├── arrs.yml │ ├── blog.yml │ ├── comps.yml │ ├── dns.yml │ ├── gitea.yml │ ├── mariadb.yml │ ├── metrics.yml │ ├── plex.yml │ ├── postgres.yml │ ├── proxy.yml │ ├── torrents.yml │ ├── unifi.yml │ ├── usenet.yml │ ├── utilities.yml │ ├── vpn.yml │ └── wordpress.yml ├── traefik.yml └── vault.yml The docker.yml file contains general docker variables, such as puid/pgid and docker network information The traefik.yml file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task) The vault.yml file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information. The remaining variables are contained in the group_vars/all/roles folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:
" />
<meta property="og:url" content="http://localhost:1313/roles/" />
<meta property="og:site_name" content="Le Tour De Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">













</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Le Tour De Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/playbook/">Ansible (Playbook)</a></li>
        
      
        
          <li><a href="/roles/">Ansible (Roles)</a></li>
        
      
        
          <li><a href="/common/">Ansible (Common-Tasks)</a></li>
        
      
        
          <li><a href="/misc/">Ansible (Misc)</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about/" >About</a></li>
        
      
        
          <li><a href="/playbook/" >Ansible (Playbook)</a></li>
        
      
        
          <li><a href="/roles/" >Ansible (Roles)</a></li>
        
      
        
          <li><a href="/common/" >Ansible (Common-Tasks)</a></li>
        
      
        
          <li><a href="/misc/" >Ansible (Misc)</a></li>
        
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/roles/">Structuring your Ansible Roles</a>
  </h1>
  <div class="post-meta"><span class="post-reading-time">15 min read (3026 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/roles/">roles</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/ansible/">ansible</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#group_vars">Group_Vars</a>
      <ul>
        <li><a href="#roledefaults">Role/Defaults</a></li>
      </ul>
    </li>
    <li><a href="#rolefiles">Role/Files</a></li>
    <li><a href="#roletasks">Role/Tasks</a>
      <ul>
        <li><a href="#clean-up">Clean Up</a></li>
        <li><a href="#directories">Directories</a></li>
        <li><a href="#databases">Databases</a></li>
        <li><a href="#sub-tasks">Sub-tasks</a></li>
      </ul>
    </li>
    <li><a href="#templates">Templates</a>
      <ul>
        <li><a href="#configs">Configs</a></li>
        <li><a href="#compose">Compose</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <hr>
<h2 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.</p>
<hr>
<h2 id="group_vars">Group_Vars<a href="#group_vars" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>For my set up, group_vars, is structured like the following:</p>
<pre tabindex="0"><code class="language-cli" data-lang="cli">
/ansible/group_vars
└── all
    ├── docker.yml
    ├── roles
    │   ├── arrs.yml
    │   ├── blog.yml
    │   ├── comps.yml
    │   ├── dns.yml
    │   ├── gitea.yml
    │   ├── mariadb.yml
    │   ├── metrics.yml
    │   ├── plex.yml
    │   ├── postgres.yml
    │   ├── proxy.yml
    │   ├── torrents.yml
    │   ├── unifi.yml
    │   ├── usenet.yml
    │   ├── utilities.yml
    │   ├── vpn.yml
    │   └── wordpress.yml
    ├── traefik.yml
    └── vault.yml
</code></pre><ol>
<li>The <code>docker.yml</code> file contains general docker variables, such as puid/pgid and docker network information</li>
<li>The <code>traefik.yml</code> file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task)</li>
<li>The <code>vault.yml</code> file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information.</li>
</ol>
<p>The remaining variables are contained in the <code>group_vars/all/roles</code> folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_name</span>: <span style="color:#e6db74">&#39;radarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/hotio/radarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_ports_host</span>: <span style="color:#e6db74">&#39;7878&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_ports_cont</span>: <span style="color:#e6db74">&#39;7878&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_location</span>: <span style="color:#e6db74">&#39;/opt/{{ radarr_name }}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_root_folder</span>: <span style="color:#e6db74">&#39;/media/movies&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_quality_profile</span>: <span style="color:#e6db74">&#39;Remux + WEB 1080p&#39;</span>
</span></span></code></pre></div><p>Above, the name/ports/location are required by the arrs role to deploy Radarr.</p>
<p>The reason these are defined in group_vars rather than within each role is because these may be required by not just one role but multiple, for example:</p>
<ul>
<li>Role 1 - Prepares and deploys Radarr</li>
<li>Role 2 - Prepares and deploys Doplarr and Jellyseerr</li>
<li>Role 3 - Prepares and deploys Radarr Prometheus exporter</li>
</ul>
<p>In the above example, all three roles will require Radarr&rsquo;s service name, port, location and api. Rather than defining these multiple times, they&rsquo;re defined once in group_vars.</p>
<p>Remember: The benefit of defaults variables, aside from sharing information between roles, is to have the ability to quickly change their value and have it represented throughout all roles/tasks that use it.</p>
<hr>
<h3 id="roledefaults">Role/Defaults<a href="#roledefaults" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Previously, I would include defaults required by multiple roles in group_vars and the remainder in role defaults, but this led to a mish-mash of defaults in different locations. With the adoption of common tasks to handle things, such as traefik labels, I was able to minimise the amount of defaults and moved all to group_vars. One thing I did like to do when using role defaults was to include &lsquo;defaults&rsquo; in the variable name:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## metrics/defaults/main/exporters.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># BASICS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;{{ bazarr_name }}-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/onedr0p/exportarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;{{ lidarr_name }}-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/onedr0p/exportarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;plex-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/axsuul/plex-media-server-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Note: bazarr_name and lidarr_name are defined in group_vars (see above).</span>
</span></span></code></pre></div><p>You also might like to have role defaults that are used throughout the role, with these defaults pointing to group_vars. I simply prefer to have as few variables as possible.</p>
<hr>
<h2 id="rolefiles">Role/Files<a href="#rolefiles" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>When I want to copy a file for a service, I include them in the role/files folder, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">/ansible/roles/blog</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">├── files</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── favicon.png</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── hugo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── og-image.png</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   └── terminal.css</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">├── tasks</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   └── main.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">└── templates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">├── blog-stack.yml.j2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">└── configs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">└── hugo.toml.j2</span>
</span></span></code></pre></div><p>Above, I have themes files for my Hugo blog which are copied during the play to the hugo/static folder. Generally, I prefer to template files during the play, but in cases, such as the above, I don&rsquo;t need to change or edit the files and simply need them copied.</p>
<hr>
<h2 id="roletasks">Role/Tasks<a href="#roletasks" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>The role tasks contain everything required to automate what I need, with idempotence (that is, to be able to run the role as many times as I want and have it fulfill the tasks I set it out to do without fail). What I have found works best is to have as many tasks follow a streamlined and common structure as possible whenever you make a role. When deploying docker services, I have the following set of tasks:</p>
<hr>
<h3 id="clean-up">Clean Up<a href="#clean-up" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>When carrying out tasks, it is best to bring down existing services. This is prevent any issues when making changes to running services. Also some changes will not be registered until a container or service is redeployed.</p>
<p><strong>Bringing down a container:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove existing container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_container</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_default_behavior</span>: <span style="color:#ae81ff">compatibility</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ radarr_name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">stop_timeout</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">remove_radarr_docker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">delay</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">until</span>: <span style="color:#ae81ff">remove_radarr_docker is succeeded</span>
</span></span></code></pre></div><p><strong>Bringing down a Compose stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Check if gluetun compose exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.stat</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;/opt/gluetun-compose.yml&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">gluetun_compose_yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove gluetun compose stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">gluetun_compose_yaml.stat.exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_compose_v2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project_src</span>: <span style="color:#e6db74">&#39;/opt&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">files</span>: <span style="color:#ae81ff">gluetun-compose.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove gluetun-compose file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">gluetun_compose_yaml.stat.exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;/opt/gluetun-compose.yml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><p><strong>Bringing down a Swarm stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove arrs stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_stack</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">arrs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove arrs-stack file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/arrs-stack.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><hr>
<h3 id="directories">Directories<a href="#directories" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>I then create directories and sub-directories required for the role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create directories</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;directory&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#e6db74">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0755&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ bazarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ bazarr_location }}/config&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ lidarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ prowlarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ radarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ radarr_4k_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ readarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sonarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sonarr_4k_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ whisparr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ whisparr_v3_location }}&#39;</span>
</span></span></code></pre></div><p>Typically, the only thing differing between roles are directory paths, so it&rsquo;s a case of looping over directory paths. However, sometimes I may require different permissions (i.e, bitnami services). In these cases, you can iterate over a list of required hashes, as below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create directories</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ item.path }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;directory&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#e6db74">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ item.owner }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ item.group }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0755&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_logs_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_redis_location }}&#39;</span><span style="color:#f92672">, owner: &#39;1001&#39;, group</span>: <span style="color:#e6db74">&#39;1001&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ traefik_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ traefik_logs_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span></code></pre></div><p>Above, I loop over <code>path</code>, <code>owner</code>, <code>group</code>. However, you can name them whatever you want, as long as it matches up with the value after <code>item.</code>.</p>
<hr>
<h3 id="databases">Databases<a href="#databases" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>In this section I create any required postgres or mariadb databases using the relevant ansible modules:</p>
<p><strong>MariaDB</strong></p>
<p>For MariaDB, I have a single task within the role that checks for a database and creates one if none exists.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create mariadb database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.mysql.mysql_db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_host</span>: <span style="color:#e6db74">&#39;{{ pvr_machine }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_user</span>: <span style="color:#e6db74">&#39;root&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_password</span>: <span style="color:#e6db74">&#39;{{ mariadb_password }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_port</span>: <span style="color:#e6db74">&#39;{{ mariadb_ports_host }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;wordpress&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p><strong>Postgres</strong></p>
<p>For Postgres I have a set of <a href="https://drjoyce.blog/common/">common tasks defined elsewhere</a> that is included using <code>ansible.builtin.include_tasks</code>. All that is required here are the name of the databases.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Conduct Postgres DB tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.include_tasks</span>: <span style="color:#ae81ff">/ansible/common/postgres.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">postgres_database</span>: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;bazarr&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;lidarr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;lidarr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;prowlarr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;prowlarr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;radarr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;radarr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;radarr-4k-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;radarr-4k-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;readarr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;readarr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;readarr-cache&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;sonarr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;sonarr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;sonarr-4k-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;sonarr-4k-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;whisparr-main&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;whisparr-log&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;whisparr-main-v3&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;whisparr-log-v3&#39;</span>
</span></span></code></pre></div><p>In both cases, an existing mariadb/postgres database instance is up and accepting connections, and all relevant database login details are stored in <code>group_vars/vault</code> prior to running these tasks. I deploy my databases via docker, but it doesn&rsquo;t matter if you installed via a different method. Also, since these are ansible module tasks, and are not part of your docker network, they rely on your machine ip (gathered in pre-tasks) and host port.</p>
<p>Once the database is created, sometimes, depending on the services, additional database tasks will be required. These usually revolve around adding your database details to the service config. For me, I prefer defining the database details via the services docker environmental variables, but sometimes this isn&rsquo;t possible. Sometimes I prefer editing the config, which is the case with my arrs stack:</p>
<ol>
<li>After creating the database, I use the <code>ansible.builtin.include_tasks</code> to include some common postgres config tasks contained in my <code>arrs/tasks/sub_tasks</code> folder:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Conduct Postgres config tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.include_tasks</span>: <span style="color:#ae81ff">sub_tasks/postgres.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">arrs_config_location</span>: <span style="color:#e6db74">&#39;{{ item.location }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">arrs_log_db</span>: <span style="color:#e6db74">&#39;{{ item.logdb }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">arrs_main_db</span>: <span style="color:#e6db74">&#39;{{ item.maindb }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">arrs_cache_db</span>: <span style="color:#e6db74">&#39;{{ item.cachedb }}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ lidarr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;lidarr-log&#39;, maindb: &#39;lidarr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ prowlarr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;prowlarr-log&#39;, maindb: &#39;prowlarr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ radarr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;radarr-log&#39;, maindb: &#39;radarr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ radarr_4k_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;radarr-4k-log&#39;, maindb: &#39;radarr-4k-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ readarr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;readarr-log&#39;, maindb: &#39;readarr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;readarr-cache&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ sonarr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;sonarr-log&#39;, maindb: &#39;sonarr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ sonarr_4k_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;sonarr-4k-log&#39;, maindb: &#39;sonarr-4k-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ whisparr_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;whisparr-log&#39;, maindb: &#39;whisparr-main&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ whisparr_v3_location }}&#39;</span><span style="color:#f92672">, logdb: &#39;whisparr-log-v3&#39;, maindb: &#39;whisparr-main-v3&#39;, cachedb</span>: <span style="color:#e6db74">&#39;&#39;</span> }
</span></span></code></pre></div><ol start="2">
<li>The common tasks are then conducted using the relevant variables defined above:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresUser value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresUser</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgresuser</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresPassword value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresPassword</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgrespassword</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresPort value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresPort</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgresport</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresHost value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresHost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgreshost</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresMainDb value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresMainDb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgresmaindb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresLogDb value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresLogDb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgreslogdb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Lookup PostgresCacheDb value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresCacheDb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">print_match</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">arrs_xml_postgrescachedb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresUser</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgresuser.matches[0].PostgresUser is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgresuser.matches[0].PostgresUser != postgres_username))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresUser</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ postgres_username }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresPassword</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgrespassword.matches[0].PostgresPassword is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgrespassword.matches[0].PostgresPassword != postgres_password))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresPassword</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ postgres_password }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresPort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgresport.matches[0].PostgresPort is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgresport.matches[0].PostgresPort != postgres_ports_cont))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresPort</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ postgres_ports_cont }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresHost</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgreshost.matches[0].PostgresHost is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgreshost.matches[0].PostgresHost != postgres_name))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresHost</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ postgres_name }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresMainDb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgresmaindb.matches[0].PostgresMainDb is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgresmaindb.matches[0].PostgresMainDb != arrs_main_db))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresMainDb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ arrs_main_db }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresLogDb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgreslogdb.matches[0].PostgresLogDb is not defined) or</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">(arrs_xml_postgreslogdb.matches[0].PostgresLogDb != arrs_log_db))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresLogDb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ arrs_log_db }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresCacheDb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(arrs_cache_db is not none) and (arrs_cache_db | trim | length &gt; 0)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add PostgresCacheDb</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">((arrs_xml_postgrescachedb.matches[0].PostgresCacheDb is not defined) or</span>
</span></span><span style="display:flex;"><span>             <span style="color:#ae81ff">(arrs_xml_postgrescachedb.matches[0].PostgresCacheDb != arrs_cache_db))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.general.xml</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ arrs_config_location }}/config.xml&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pretty_print</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">xpath</span>: <span style="color:#ae81ff">/Config/PostgresCacheDb</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ arrs_cache_db }}&#39;</span>
</span></span></code></pre></div><ol start="3">
<li>I then have tasks to delete any existing sqlite databases in the arrs folder:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove sqlite files</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.include_tasks</span>: <span style="color:#ae81ff">sub_tasks/sqlite.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sqlite_location</span>: <span style="color:#e6db74">&#39;{{ item.location }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sqlite_name</span>: <span style="color:#e6db74">&#39;{{ item.name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">backups_location</span>: <span style="color:#e6db74">&#39;{{ item.backups }}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ bazarr_location }}/db&#39;</span><span style="color:#f92672">, name: &#39;bazarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ bazarr_location }}/backup&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ lidarr_location }}&#39;</span><span style="color:#f92672">, name: &#39;lidarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ lidarr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ prowlarr_location }}&#39;</span><span style="color:#f92672">, name: &#39;prowlarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ prowlarr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ radarr_location }}&#39;</span><span style="color:#f92672">, name: &#39;radarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ radarr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ radarr_4k_location }}&#39;</span><span style="color:#f92672">, name: &#39;radarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ radarr_4k_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ readarr_location }}&#39;</span><span style="color:#f92672">, name: &#39;readarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ readarr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ sonarr_location }}&#39;</span><span style="color:#f92672">, name: &#39;sonarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ sonarr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ sonarr_4k_location }}&#39;</span><span style="color:#f92672">, name: &#39;sonarr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ sonarr_4k_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ whisparr_location }}&#39;</span><span style="color:#f92672">, name: &#39;whisparr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ whisparr_location }}/Backups&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">location</span>: <span style="color:#e6db74">&#39;{{ whisparr_v3_location }}&#39;</span><span style="color:#f92672">, name: &#39;whisparr&#39;, backups</span>: <span style="color:#e6db74">&#39;{{ whisparr_v3_location }}/Backups&#39;</span> }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove sqlite files</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/logs.db&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/logs.db-shm&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/logs.db-wal&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/{{ sqlite_name }}.db&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/{{ sqlite_name }}.db-shm&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sqlite_location }}/{{ sqlite_name }}.db-wal&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove sqlite backups folders</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ backups_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><p>Of course, if you still need your sqlite databases you wouldn&rsquo;t use these. But for me, I&rsquo;ve already fully migrated to postgres, so the only time an sqlite file would show up is if something went wrong with the role.</p>
<ul>
<li>Files</li>
<li>Volumes</li>
<li>Database</li>
<li>DNS</li>
<li>Traefik</li>
<li>Deploy</li>
</ul>
<p>Removes existing stacks, retrieves common vault variables, includes sub_tasks, and then deploys the stack.</p>
<p><strong>Example:</strong></p>
<pre tabindex="0"><code>
################################
# SUB-TASKS
################################

- name: Include sub-tasks tasks
  ansible.builtin.include_tasks: sub_tasks/{{ item }}.yml
  loop:
    - &#39;rclone&#39;  ## rclone runs first to create the torrents volume
    - &#39;lidarr&#39;
    - &#39;prowlarr&#39;
    - &#39;radarr&#39;
    - &#39;radarr4k&#39;
    - &#39;readarr&#39;
    - &#39;sonarr&#39;
    - &#39;sonarr4k&#39;
    - &#39;whisparr&#39;
    - &#39;bazarr&#39;  ## bazarr relies on arrs API variables - run last

################################
# DEPLOY
################################

- name: Import arrs-stack file
  ansible.builtin.template:
    src: &#39;{{ role_path }}/templates/arrs-stack.yml.j2&#39;
    dest: /opt/compose/arrs-stack.yml
    force: true
    owner: &#39;{{ puid }}&#39;
    group: &#39;{{ pgid }}&#39;
    mode: &#39;0664&#39;

- name: Deploy arrs stack
  community.docker.docker_stack:
    state: present
    name: arrs
    compose:
      - /opt/compose/arrs-stack.yml
</code></pre><hr>
<h3 id="sub-tasks">Sub-tasks<a href="#sub-tasks" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Sub_tasks prepare a docker swarm service to run, including:</p>
<ul>
<li>Creating directories</li>
<li>Creating and preparing config files</li>
<li>Creating databases and adding database info to the config files</li>
<li>Retrieving vault variables or generating keys/api/passwords during the play</li>
<li>Preparing docker secrets</li>
<li>Creating cloudflare A/CNAME DNS records
and so on&hellip;</li>
</ul>
<p><strong>Example:</strong></p>
<pre tabindex="0"><code>## companions/tasks/sub_tasks/ombi.yml

################################
# DIRECTORY
################################

- name: Create appdata directories
  ansible.builtin.file:
    path: &#39;{{ item }}&#39;
    state: directory
    owner: &#39;{{ puid }}&#39;
    group: &#39;{{ pgid }}&#39;
    mode: &#39;0755&#39;
  loop:
    - &#39;{{ ombi_defaults_location }}&#39;
    - &#39;{{ ombi_defaults_location }}/config&#39;

################################
# POSTGRES
################################

- name: Ping for existing database
  community.postgresql.postgresql_ping:
    login_host: &#39;{{ pvr_machine }}&#39;
    login_user: &#39;{{ postgres_username }}&#39;
    login_password: &#39;{{ postgres_password }}&#39;
    port: &#39;{{ postgres_ports_host }}&#39;
    login_db: &#39;Ombi&#39;
  register: ombi_postgres_db

- name: Create postgres database
  when: not ombi_postgres_db == true
  community.postgresql.postgresql_db:
    login_host: &#39;{{ pvr_machine }}&#39;
    login_user: &#39;{{ postgres_username }}&#39;
    login_password: &#39;{{ postgres_password }}&#39;
    port: &#39;{{ postgres_ports_host }}&#39;
    name: &#39;Ombi&#39;
    state: present

- name: Import ombi database.json
  ansible.builtin.template:
    src: &#39;{{ role_path }}/templates/configs/ombi_database.json.j2&#39;
    dest: &#39;{{ ombi_defaults_location }}/config/database.json&#39;
    force: true
    owner: &#39;{{ puid }}&#39;
    group: &#39;{{ pgid }}&#39;
    mode: &#39;0664&#39;

- name: Remove sqlite database files
  ansible.builtin.file:
    path: &#39;{{ ombi_defaults_location }}/{{ item }}&#39;
    state: absent
  loop:
    - Ombi.db
    - OmbiExternal.db
    - OmbiSettings.db

################################
# CLOUDFLARE
################################

- name: Perform Cloudflare DNS tasks
  block:
    - name: Remove existing CNAME DNS record
      community.general.cloudflare_dns:
        api_token: &#39;{{ cloudflare_api }}&#39;
        zone: &#39;{{ local_domain }}&#39;
        state: &#39;absent&#39;
        type: &#39;CNAME&#39;
        record: &#39;{{ ombi_name }}&#39;

    - name: Remove existing A DNS record
      community.general.cloudflare_dns:
        api_token: &#39;{{ cloudflare_api }}&#39;
        zone: &#39;{{ local_domain }}&#39;
        state: &#39;absent&#39;
        type: &#39;A&#39;
        record: &#39;{{ ombi_name }}&#39;

    - name: Add DNS record
      community.general.cloudflare_dns:
        api_token: &#39;{{ cloudflare_api }}&#39;
        zone: &#39;{{ local_domain }}&#39;
        state: &#39;present&#39;
        solo: true
        proxied: &#39;{{ cloudflare_proxy }}&#39;
        type: &#39;{{ cloudflare_record }}&#39;
        value: &#39;{{ ipify_public_ip }}&#39;
        record: &#39;{{ ombi_name }}&#39;
      register: ombi_cloudflare_record_creation_status

    - name: Tasks on success
      when: ombi_cloudflare_record_creation_status is succeeded
      block:
        - name: Set &#39;dns_record_print&#39; variable
          ansible.builtin.set_fact:
            ombi_cloudflare_record_print: &#39;{{ (ombi_name == local_domain) | ternary(local_domain, ombi_name + &#34;.&#34; + local_domain) }}&#39;

        - name: Display DNS record creation status
          ansible.builtin.debug:
            msg: &#39;DNS A Record for &#34;{{ ombi_cloudflare_record_print }}&#34; set to &#34;{{ ipify_public_ip }}&#34; was added. Proxy: {{ cloudflare_proxy }}&#39;
</code></pre><hr>
<h2 id="templates">Templates<a href="#templates" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<hr>
<h3 id="configs">Configs<a href="#configs" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Contains nearly all my service config files, ready to be called upon during play. I find templating more powerful than simply copying, as a change in a variable&rsquo;s value will apply to all templates referencing it - no need to edit every config file individually.</p>
<p><strong>Example:</strong></p>
<pre tabindex="0"><code>## Doplarr&#39;s config (config.edn.j2)

{
 :radarr/url &#34;http://{{ radarr_name }}:{{ radarr_ports_cont }}&#34;
 :radarr/api &#34;{{ radarr_api }}&#34;
 :radarr/quality-profile &#34;{{ radarr_quality_profile }}&#34;
 :radarr/rootfolder &#34;{{ radarr_root_folder }}&#34;
 :sonarr/url &#34;http://{{ sonarr_name }}:{{ sonarr_ports_cont }}&#34;
 :sonarr/api &#34;{{ sonarr_api }}&#34;
 :sonarr/quality-profile &#34;{{ sonarr_quality_profile }}&#34;
 :sonarr/rootfolder &#34;{{ sonarr_root_folder }}&#34;
 :sonarr/season-folders true
 :partial-seasons true
 :discord/token &#34;{{ doplarr_token }}&#34;
 :discord/max-results 25
 :discord/requested-msg-style :plain
 :log-level :trace
 }
</code></pre><p><strong>Which is then called with the following tasks:</strong></p>
<pre tabindex="0"><code>################################
# CONFIG
################################

- name: Check if doplarr config.edn exists
  ansible.builtin.stat:
    path: &#39;{{ doplarr_defaults_location }}/config.edn&#39;
  register: doplarr_config_edn

- name: Load doplarr vault variable
  when: not doplarr_config_edn.stat.exists
  ansible.builtin.set_fact:
    doplarr_token: &#39;{{ lookup(&#34;ini&#34;, &#34;doplarr_token section=&#34; + &#34;companions&#34; + &#34; file=&#34; + &#34;/ansible/vault.ini&#34;) }}&#39;

- name: Create doplarr config.edn file
  when: not doplarr_config_edn.stat.exists
  block:
    - name: Import config file
      ansible.builtin.template:
        src: &#39;{{ role_path }}/templates/configs/doplarr_config.edn.j2&#39;
        dest: &#39;{{ doplarr_defaults_location }}/config.edn&#39;
        force: true
        owner: &#39;{{ puid }}&#39;
        group: &#39;{{ pgid }}&#39;
        mode: &#39;0664&#39;

    - name: Wait for &#39;config.edn&#39; to be created
      ansible.builtin.wait_for:
        path: &#39;{{ doplarr_defaults_location }}/config.edn&#39;
        state: present
</code></pre><hr>
<h3 id="compose">Compose<a href="#compose" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Aside from the configs, the docker compose file is also templated, containing relevant (to the role) and related docker services.</p>
<p><strong>Example:</strong></p>
<pre tabindex="0"><code>version: &#39;3.9&#39;

services:
  {{ adguard_defaults_name }}:
    image: {{ adguard_defaults_image_repo }}:{{ adguard_defaults_image_tag }}
    networks:
      - {{ network_overlay }}
    environment:
      PUID: &#39;{{ puid }}&#39;
      PGID: &#39;{{ pgid }}&#39;
      TZ: &#39;{{ timezone }}&#39;
    ports:
      - target: {{ adguard_defaults_ports_cont }}
        published: {{ adguard_defaults_ports_host }}
        protocol: tcp
        mode: ingress
      - target: {{ adguard_defaults_ports_dns_cont }}
        published: {{ adguard_defaults_ports_dns_host }}
        protocol: tcp
        mode: ingress
      - target: {{ adguard_defaults_ports_dns_cont }}
        published: {{ adguard_defaults_ports_dns_host }}
        protocol: udp
        mode: ingress
    volumes:
      - type: bind
        source: {{ adguard_defaults_location }}/work
        target: /opt/adguardhome/work
      - type: bind
        source: {{ adguard_defaults_location }}/conf
        target: /opt/adguardhome/conf
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.labels.ansible_host == pvr]
      labels: {{ adguard_defaults_labels }}

networks:
  {{ network_overlay }}:
    external: true
</code></pre><p>With the compose files, you can either create and define networks, volumes, secrets within the file, or you can let ansible handle it and then use &rsquo;external: true&rsquo;. I prefer the latter and use various docker ansible modules to automate their creation:</p>
<p><strong>Networks:</strong></p>
<pre tabindex="0"><code>- name: Conduct overlay network tasks
  when: inventory_hostname == &#39;localhost&#39;
  block:
    - name: Register overlay network
      community.docker.docker_network_info:
        name: &#39;{{ network_overlay }}&#39;
      register: network_overlay_result

    - name: Create overlay network
      when: not network_overlay_result.exists
      community.docker.docker_network:
        name: &#39;{{ network_overlay }}&#39;
        driver: &#39;{{ network_overlay_driver }}&#39;
        attachable: true 
        ipam_config:
          - subnet: &#39;{{ network_overlay_subnet }}&#39;
</code></pre><p><strong>Volumes:</strong></p>
<pre tabindex="0"><code>- name: Create media volume
  community.docker.docker_volume:
    volume_name: &#39;{{ media_volume }}&#39;
    state: present
    recreate: options-changed
    driver: local
    driver_options:
      type: nfs
      o: &#39;addr={{ media_volume_address }},rw,nfsvers=4.2&#39;
      device: &#39;{{ media_volume_device }}&#39;
</code></pre><p><strong>Secrets:</strong></p>
<pre tabindex="0"><code>- name: Prepare docker secrets
  block:
    - name: Unifi db user secret
      community.docker.docker_secret:
        name: unifi_user_secret
        data: &#39;{{ unifi_db_user }}&#39;
        state: present

    - name: Unifi db password secret
      community.docker.docker_secret:
        name: unifi_pass_secret
        data: &#39;{{ unifi_db_pass }}&#39;
        state: present

    - name: Unifi db root password secret
      community.docker.docker_secret:
        name: unifi_root_pass_secret
        data: &#39;{{ unifi_db_root_pass }}&#39;
        state: present
</code></pre>
      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
