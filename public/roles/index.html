<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Structuring your Ansible Roles :: Le Tour De Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Introduction Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.
Group_Vars For my set up, group_vars, is structured like the following:
/ansible/group_vars └── all ├── docker.yml ├── roles │ ├── arrs.yml │ ├── blog.yml │ ├── comps.yml │ ├── dns.yml │ ├── gitea.yml │ ├── mariadb.yml │ ├── metrics.yml │ ├── plex.yml │ ├── postgres.yml │ ├── proxy.yml │ ├── torrents.yml │ ├── unifi.yml │ ├── usenet.yml │ ├── utilities.yml │ ├── vpn.yml │ └── wordpress.yml ├── traefik.yml └── vault.yml The docker.yml file contains general docker variables, such as puid/pgid and docker network information The traefik.yml file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task) The vault.yml file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information. The remaining variables are contained in the group_vars/all/roles folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/roles/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="http://localhost:1313/terminal.css">




<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Structuring your Ansible Roles">
<meta property="og:description" content=" Introduction Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.
Group_Vars For my set up, group_vars, is structured like the following:
/ansible/group_vars └── all ├── docker.yml ├── roles │ ├── arrs.yml │ ├── blog.yml │ ├── comps.yml │ ├── dns.yml │ ├── gitea.yml │ ├── mariadb.yml │ ├── metrics.yml │ ├── plex.yml │ ├── postgres.yml │ ├── proxy.yml │ ├── torrents.yml │ ├── unifi.yml │ ├── usenet.yml │ ├── utilities.yml │ ├── vpn.yml │ └── wordpress.yml ├── traefik.yml └── vault.yml The docker.yml file contains general docker variables, such as puid/pgid and docker network information The traefik.yml file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task) The vault.yml file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information. The remaining variables are contained in the group_vars/all/roles folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:
" />
<meta property="og:url" content="http://localhost:1313/roles/" />
<meta property="og:site_name" content="Le Tour De Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">













</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Le Tour De Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/playbook/">Ansible (Playbook)</a></li>
        
      
        
          <li><a href="/roles/">Ansible (Roles)</a></li>
        
      
        
          <li><a href="/common/">Ansible (Common-Tasks)</a></li>
        
      
        
          <li><a href="/misc/">Ansible (Misc)</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about/" >About</a></li>
        
      
        
          <li><a href="/playbook/" >Ansible (Playbook)</a></li>
        
      
        
          <li><a href="/roles/" >Ansible (Roles)</a></li>
        
      
        
          <li><a href="/common/" >Ansible (Common-Tasks)</a></li>
        
      
        
          <li><a href="/misc/" >Ansible (Misc)</a></li>
        
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/roles/">Structuring your Ansible Roles</a>
  </h1>
  <div class="post-meta"><span class="post-reading-time">14 min read (2847 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/roles/">roles</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/ansible/">ansible</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#group_vars">Group_Vars</a>
      <ul>
        <li><a href="#roledefaults">Role/Defaults</a></li>
      </ul>
    </li>
    <li><a href="#rolefiles">Role/Files</a></li>
    <li><a href="#roletasks">Role/Tasks</a>
      <ul>
        <li><a href="#clean-up">Clean Up</a></li>
        <li><a href="#directories">Directories</a></li>
        <li><a href="#files">Files</a></li>
        <li><a href="#databases">Databases</a></li>
        <li><a href="#docker-secrets--networks--volumes">Docker Secrets / Networks / Volumes</a></li>
        <li><a href="#dns">DNS</a></li>
        <li><a href="#traefik">Traefik</a></li>
        <li><a href="#deploy">Deploy</a></li>
      </ul>
    </li>
    <li><a href="#rolessub-tasks">Roles/Sub-tasks</a>
      <ul>
        <li><a href="#compose">Compose</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <hr>
<h2 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>Ansible roles contain the majority of my tasks that automate the setup and deployment of my Docker containers and Swarm services. During my time with Ansible, my roles have changed a lot, both content and structure wise.</p>
<hr>
<h2 id="group_vars">Group_Vars<a href="#group_vars" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>For my set up, group_vars, is structured like the following:</p>
<pre tabindex="0"><code class="language-cli" data-lang="cli">
/ansible/group_vars
└── all
    ├── docker.yml
    ├── roles
    │   ├── arrs.yml
    │   ├── blog.yml
    │   ├── comps.yml
    │   ├── dns.yml
    │   ├── gitea.yml
    │   ├── mariadb.yml
    │   ├── metrics.yml
    │   ├── plex.yml
    │   ├── postgres.yml
    │   ├── proxy.yml
    │   ├── torrents.yml
    │   ├── unifi.yml
    │   ├── usenet.yml
    │   ├── utilities.yml
    │   ├── vpn.yml
    │   └── wordpress.yml
    ├── traefik.yml
    └── vault.yml
</code></pre><ol>
<li>The <code>docker.yml</code> file contains general docker variables, such as puid/pgid and docker network information</li>
<li>The <code>traefik.yml</code> file contains traefik middleware and a traefik labels template variables (used by the traefik labels common task)</li>
<li>The <code>vault.yml</code> file contains all sensitive variables, including api/keys/domains/passwords/emails and any other sensitive information.</li>
</ol>
<p>The remaining variables are contained in the <code>group_vars/all/roles</code> folder, with one group_vars file per role. These contain all the relevant information required to get the roles services up and running, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_name</span>: <span style="color:#e6db74">&#39;radarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/hotio/radarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_ports_host</span>: <span style="color:#e6db74">&#39;7878&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_ports_cont</span>: <span style="color:#e6db74">&#39;7878&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_location</span>: <span style="color:#e6db74">&#39;/opt/{{ radarr_name }}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_root_folder</span>: <span style="color:#e6db74">&#39;/media/movies&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">radarr_quality_profile</span>: <span style="color:#e6db74">&#39;Remux + WEB 1080p&#39;</span>
</span></span></code></pre></div><p>Above, the name/ports/location are required by the arrs role to deploy Radarr.</p>
<p>The reason these are defined in group_vars rather than within each role is because these may be required by not just one role but multiple, for example:</p>
<ul>
<li>Role 1 - Prepares and deploys Radarr</li>
<li>Role 2 - Prepares and deploys Doplarr and Jellyseerr</li>
<li>Role 3 - Prepares and deploys Radarr Prometheus exporter</li>
</ul>
<p>In the above example, all three roles will require Radarr&rsquo;s service name, port, location and api. Rather than defining these multiple times, they&rsquo;re defined once in group_vars.</p>
<p>Remember: The benefit of defaults variables, aside from sharing information between roles, is to have the ability to quickly change their value and have it represented throughout all roles/tasks that use it.</p>
<hr>
<h3 id="roledefaults">Role/Defaults<a href="#roledefaults" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Previously, I would include defaults required by multiple roles in group_vars and the remainder in role defaults, but this led to a mish-mash of defaults in different locations. With the adoption of common tasks to handle things, such as traefik labels, I was able to minimise the amount of defaults and moved all to group_vars. One thing I did like to do when using role defaults was to include &lsquo;defaults&rsquo; in the variable name:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## metrics/defaults/main/exporters.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># BASICS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;{{ bazarr_name }}-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/onedr0p/exportarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bazarr_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;{{ lidarr_name }}-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/onedr0p/exportarr&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lidarr_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_name</span>: <span style="color:#e6db74">&#39;plex-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_image_repo</span>: <span style="color:#e6db74">&#39;ghcr.io/axsuul/plex-media-server-exporter&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">plex_exporter_defaults_image_tag</span>: <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Note: bazarr_name and lidarr_name are defined in group_vars (see above).</span>
</span></span></code></pre></div><p>You also might like to have role defaults that are used throughout the role, with these defaults pointing to group_vars. I simply prefer to have as few variables as possible.</p>
<hr>
<h2 id="rolefiles">Role/Files<a href="#rolefiles" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>When I want to copy a file for a service, I include them in the role/files folder, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">/ansible/roles/blog</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">├── files</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── favicon.png</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── hugo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   ├── og-image.png</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   └── terminal.css</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">├── tasks</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">│   └── main.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">└── templates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">├── blog-stack.yml.j2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">└── configs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">└── hugo.toml.j2</span>
</span></span></code></pre></div><p>Above, I have themes files for my Hugo blog which are copied during the play to the hugo/static folder. Generally, I prefer to template files during the play, but in cases, such as the above, I don&rsquo;t need to change or edit the files and simply need them copied.</p>
<hr>
<h2 id="roletasks">Role/Tasks<a href="#roletasks" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>The role tasks contain everything required to automate what I need, with idempotence (that is, to be able to run the role as many times as I want and have it fulfill the tasks I set it out to do without fail). What I have found works best is to have as many tasks follow a streamlined and common structure as possible whenever you make a role. When deploying docker services, I have the following set of tasks:</p>
<hr>
<h3 id="clean-up">Clean Up<a href="#clean-up" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>When carrying out tasks, it is best to bring down existing services. This is prevent any issues when making changes to running services. Also some changes will not be registered until a container or service is redeployed.</p>
<p><strong>Bringing down a container:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove existing container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_container</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_default_behavior</span>: <span style="color:#ae81ff">compatibility</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ radarr_name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">stop_timeout</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">remove_radarr_docker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">delay</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">until</span>: <span style="color:#ae81ff">remove_radarr_docker is succeeded</span>
</span></span></code></pre></div><p><strong>Bringing down a Compose stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Check if gluetun compose exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.stat</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;/opt/gluetun-compose.yml&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">gluetun_compose_yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove gluetun compose stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">gluetun_compose_yaml.stat.exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_compose_v2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project_src</span>: <span style="color:#e6db74">&#39;/opt&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">files</span>: <span style="color:#ae81ff">gluetun-compose.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove gluetun-compose file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">gluetun_compose_yaml.stat.exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;/opt/gluetun-compose.yml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><p><strong>Bringing down a Swarm stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove arrs stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_stack</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">arrs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove arrs-stack file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/arrs-stack.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span></code></pre></div><hr>
<h3 id="directories">Directories<a href="#directories" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>I then create directories and sub-directories required for the role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create directories</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ item }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;directory&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#e6db74">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0755&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ bazarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ bazarr_location }}/config&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ lidarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ prowlarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ radarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ radarr_4k_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ readarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sonarr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ sonarr_4k_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ whisparr_location }}&#39;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;{{ whisparr_v3_location }}&#39;</span>
</span></span></code></pre></div><p>Typically, the only thing differing between roles are directory paths, so it&rsquo;s a case of looping over directory paths. However, sometimes I require different permissions (i.e, bitnami), as below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create directories</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ item.path }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;directory&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#e6db74">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ item.owner }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ item.group }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0755&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_logs_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ authelia_redis_location }}&#39;</span><span style="color:#f92672">, owner: &#39;1001&#39;, group</span>: <span style="color:#e6db74">&#39;1001&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ traefik_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ traefik_logs_location }}&#39;</span><span style="color:#f92672">, owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span><span style="color:#f92672">, group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span> }
</span></span></code></pre></div><p>Above, I loop over <code>path</code>, <code>owner</code>, <code>group</code>. However, you can name them whatever you want, as long as it matches up with the value after <code>item.</code>.</p>
<hr>
<h3 id="files">Files<a href="#files" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>I deal with files using common tasks for <a href="https://drjoyce.blog/common/#templates">templates</a> and <a href="https://drjoyce.blog/common/#file-copy">copy tasks</a>.</p>
<hr>
<h3 id="databases">Databases<a href="#databases" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Here I create postgres/mariadb databases using ansible modules:</p>
<p><strong>MariaDB</strong></p>
<p>I have a single task that checks for a database and creates one if none exists.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create mariadb database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.mysql.mysql_db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_host</span>: <span style="color:#e6db74">&#39;{{ pvr_machine }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_user</span>: <span style="color:#e6db74">&#39;root&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_password</span>: <span style="color:#e6db74">&#39;{{ mariadb_password }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">login_port</span>: <span style="color:#e6db74">&#39;{{ mariadb_ports_host }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;wordpress&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p><strong>Postgres</strong></p>
<p>I have <a href="https://drjoyce.blog/common/">common tasks defined elsewhere</a>.</p>
<p>Both require an existing mariadb/postgres database instance that is up and accepting connections, with all relevant database login details stored in <code>group_vars/vault</code>. I deploy my databases via docker, but it doesn&rsquo;t matter if you installed via a different method. Also, since these are ansible module tasks, and are not part of your docker network, they rely on machine ip and host port.</p>
<p>Once the database is created, depending on the services, additional database tasks will be required. These usually revolve around adding your database details to the service config. For me, I prefer defining the database details via the services docker environmental variables, but sometimes this isn&rsquo;t possible. Sometimes I prefer editing the config, which is the case with my arrs stack.</p>
<hr>
<h3 id="docker-secrets--networks--volumes">Docker Secrets / Networks / Volumes<a href="#docker-secrets--networks--volumes" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Here I create any required docker secrets, networks and volumes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Prepare docker secrets</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_secret</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ item.name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data</span>: <span style="color:#e6db74">&#39;{{ item.secret }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loop</span>:
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">name: &#39;unifi_user_secret&#39;, secret</span>: <span style="color:#e6db74">&#39;{{ unifi_db_user }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">name: &#39;unifi_pass_secret&#39;, secret</span>: <span style="color:#e6db74">&#39;{{ unifi_db_pass }}&#39;</span> }
</span></span><span style="display:flex;"><span>    - { <span style="color:#f92672">name: &#39;unifi_root_pass_secret&#39;, secret</span>: <span style="color:#e6db74">&#39;{{ unifi_db_root_pass }}&#39;</span> }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create media volume</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_volume</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volume_name</span>: <span style="color:#e6db74">&#39;{{ media_volume }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">recreate</span>: <span style="color:#ae81ff">options-changed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">local</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver_options</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">nfs</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">o</span>: <span style="color:#e6db74">&#39;addr={{ media_volume_address }},rw,nfsvers=4.2&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">device</span>: <span style="color:#e6db74">&#39;{{ media_volume_device }}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Conduct overlay network tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">inventory_hostname == &#39;localhost&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Register overlay network</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.docker.docker_network_info</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ network_overlay }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">network_overlay_result</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create overlay network</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">not network_overlay_result.exists</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.docker.docker_network</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ network_overlay }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">driver</span>: <span style="color:#e6db74">&#39;{{ network_overlay_driver }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">attachable</span>: <span style="color:#66d9ef">true</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ipam_config</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">subnet</span>: <span style="color:#e6db74">&#39;{{ network_overlay_subnet }}&#39;</span>
</span></span></code></pre></div><hr>
<h3 id="dns">DNS<a href="#dns" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>In this section, I add cloudflare DNS records via <a href="https://drjoyce.blog/common/#cloudflare-dns">common tasks</a></p>
<p>Previously, I would define the cloudflare tasks in the role, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CLOUDFLARE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Perform Cloudflare DNS tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove existing CNAME DNS record</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.general.cloudflare_dns</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">api_token</span>: <span style="color:#e6db74">&#39;{{ cloudflare_api }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">zone</span>: <span style="color:#e6db74">&#39;{{ local_domain }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;absent&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#39;CNAME&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">record</span>: <span style="color:#e6db74">&#39;{{ ombi_name }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove existing A DNS record</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.general.cloudflare_dns</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">api_token</span>: <span style="color:#e6db74">&#39;{{ cloudflare_api }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">zone</span>: <span style="color:#e6db74">&#39;{{ local_domain }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;absent&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">record</span>: <span style="color:#e6db74">&#39;{{ ombi_name }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add DNS record</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">community.general.cloudflare_dns</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">api_token</span>: <span style="color:#e6db74">&#39;{{ cloudflare_api }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">zone</span>: <span style="color:#e6db74">&#39;{{ local_domain }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#39;present&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">solo</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxied</span>: <span style="color:#e6db74">&#39;{{ cloudflare_proxy }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#39;{{ cloudflare_record }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;{{ ipify_public_ip }}&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">record</span>: <span style="color:#e6db74">&#39;{{ ombi_name }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">ombi_cloudflare_record_creation_status</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Tasks on success</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">ombi_cloudflare_record_creation_status is succeeded</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Set &#39;dns_record_print&#39; variable</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ansible.builtin.set_fact</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">ombi_cloudflare_record_print</span>: <span style="color:#e6db74">&#39;{{ (ombi_name == local_domain) | ternary(local_domain, ombi_name + &#34;.&#34; + local_domain) }}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Display DNS record creation status</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ansible.builtin.debug</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">msg</span>: <span style="color:#e6db74">&#39;DNS A Record for &#34;{{ ombi_cloudflare_record_print }}&#34; set to &#34;{{ ipify_public_ip }}&#34; was added. Proxy: {{ cloudflare_proxy }}&#39;</span>
</span></span></code></pre></div><hr>
<h3 id="traefik">Traefik<a href="#traefik" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Here I use <a href="https://drjoyce.blog/common/#traefik-labels">common tasks</a> to set Traefik labels for services.</p>
<hr>
<h3 id="deploy">Deploy<a href="#deploy" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>The final step of tasks is to deploy the required container or stack:</p>
<p><strong>Deploying a container:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create radarr container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_container</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ radarr_name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#39;{{ radarr_image_repo }}:{{ radarr_image_tag }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#e6db74">&#39;{{ network_overlay }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PUID</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PGID</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TZ</span>: <span style="color:#e6db74">&#39;{{ timezone }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TP_SCHEME</span>: <span style="color:#e6db74">&#39;http&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TP_DOMAIN</span>: <span style="color:#e6db74">&#39;{{ themepark_domain }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TP_HOTIO</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TP_THEME</span>: <span style="color:#e6db74">&#39;{{ themepark_theme }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: <span style="color:#e6db74">&#39;{{ radarr_labels }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;{{ radarr_ports_host }}:{{ radarr_ports_cont }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;{{ radarr_location }}:/config&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;{{ themes_location }}/98-themepark-radarr:/etc/cont-init.d/98-themepark&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/mnt:/mnt&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;{{ torrents_volume }}:{{ torrents_volume_mount_path }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart_policy</span>: <span style="color:#e6db74">&#39;{{ radarr_restart_policy }}&#39;</span>
</span></span></code></pre></div><p><strong>Deploying a Compose stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Import gluetun compose file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#39;{{ role_path }}/templates/gluetun-compose.yml.j2&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#39;/opt/gluetun-compose.yml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0664&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Gluetun compose stack up</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_compose_v2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">project_src</span>: <span style="color:#e6db74">&#39;/opt&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">files</span>: <span style="color:#ae81ff">gluetun-compose.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p><strong>Deploying a Swarm stack:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Import arrs-stack file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#39;{{ role_path }}/templates/arrs-stack.yml.j2&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/opt/arrs-stack.yml</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">force</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0664&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Deploy arrs stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_stack</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">arrs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">compose</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/opt/arrs-stack.yml</span>
</span></span></code></pre></div><hr>
<h2 id="rolessub-tasks">Roles/Sub-tasks<a href="#rolessub-tasks" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>I make use of sub-tasks in roles if a set of tasks meet the following criteria:</p>
<ol>
<li>The tasks are role specific/niche and not appropriate for common tasks</li>
<li>The number of tasks would clutter up the main tasks file.</li>
</ol>
<p>One example is my recyclarr config tasks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Include recyclarr tasks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.include_tasks</span>: <span style="color:#ae81ff">sub_tasks/recyclarr.yml</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CONFIG</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Check config exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.stat</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ recyclarr_location }}/recyclarr.yml&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">recyclarr_config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Generate default config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">not recyclarr_config.stat.exists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_container</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">recyclarr-config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#39;{{ recyclarr_image_repo }}:{{ recyclarr_image_tag }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pull</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_default_behavior</span>: <span style="color:#ae81ff">compatibility</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;{{ network_overlay }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RECYCLARR_CREATE_CONFIG</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#e6db74">&#39;{{ puid }}:{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;{{ recyclarr_location }}:/config&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cleanup</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove config container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">community.docker.docker_container</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_default_behavior</span>: <span style="color:#ae81ff">compatibility</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">recyclarr-config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">absent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">stop_timeout</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">remove_recyclarr_config_container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">delay</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">until</span>: <span style="color:#ae81ff">remove_recyclarr_config_container is succeeded</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SECRETS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Insert recyclarr secrets settings</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.blockinfile</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ recyclarr_location }}/secrets.yml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">marker</span>: <span style="color:#e6db74">&#34;## {mark} ANSIBLE RECYCLARR MANAGED BLOCK ##&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0664&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">block</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      radarr_base_url: http://{{ radarr_name }}:{{ radarr_ports_cont }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      radarr_api_key: {{ radarr_api }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      radarr4k_base_url: http://{{ radarr_4k_name }}:{{ radarr_4k_ports_cont }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      radarr4k_api_key: {{ radarr_4k_api }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sonarr_base_url: http://{{ sonarr_name }}:{{ sonarr_ports_cont }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sonarr_api_key: {{ sonarr_api }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sonarr4k_base_url: http://{{ sonarr_4k_name }}:{{ sonarr_4k_ports_cont }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      sonarr4k_api_key: {{ sonarr_4k_api }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CONFIGS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## This is just one of the configs. I have another three.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Insert radarr config settings</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ansible.builtin.blockinfile</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#39;{{ recyclarr_location }}/configs/radarr.yml&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">marker</span>: <span style="color:#e6db74">&#34;## {mark} ANSIBLE RADARR MANAGED BLOCK ##&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0664&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">block</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      radarr:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        radarr:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          media_naming:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            folder: plex
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            movie:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              rename: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              standard: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          quality_definition:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            type: movie
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          quality_profiles:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - name: Remux + WEB 1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              reset_unmatched_scores:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              upgrade:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                allowed: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                until_quality: Remux-1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                until_score: 10000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              min_format_score: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              quality_sort: top
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              qualities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - name: Remux-1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - name: Bluray-1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  enabled: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - name: WEB 1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  qualities:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - WEBRip-1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    - WEBDL-1080p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          delete_old_custom_formats: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replace_existing_custom_formats: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          custom_formats:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            - trash_ids:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Audio Advanced #1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 417804f7f2c4308c1f4c5d380d4c4475 # ATMOS (undefined)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 1af239278386be2919e1bcee0bde047e # DD+ ATMOS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 185f1dd7264c4562b9022d963ac37424 # DD+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - f9f847ac70a0af62ea4a08280b859636 # DTS-ES
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - dcf3ec6938fa32445f590a4da84256cd # DTS-HD MA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 2f22d89048b01681dde8afe203bf2e95 # DTS X
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 1c1a4c5e823891c75bc50380a6866f73 # DTS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 496f355514737f7d83bf7aa4d24f8169 # TrueHD ATMOS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 3cafb66171b47f226146a0770576870f # TrueHD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Audio Advanced #2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 240770601cc226190c367ef59aba7463 # AAC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - c2998bd0d90ed5621d8df281e839436e # DD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 8e109e50e0a0b83a5098b056e13bf6db # DTS-HD HRA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - a570d4a0e56a2874b64e5bfa55202a1b # FLAC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 6ba9033150e7896bdc9ec4b44f2b230f # MP3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - a061e2e700f81932daf888599f8a8273 # Opus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e7c2fcae07cbada050a0af3357491d7b # PCM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # HDR Formats
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e23edd2482476e595fb990b12e7c609c # DV HDR10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 55d53828b9d81cbe20b02efd00aa0efd # DV HLG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - a3e19f8f627608af0211acd02bf89735 # DV SDR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 58d6a88f13e2db7f5059c41047876f00 # DV
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 2a4d9069cc1fe3242ff9bdaebed239bb # HDR (undefined)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e61e28db95d22bedcadf030b8f156d96 # HDR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - dfb86d5941bc9075d6af23b09c2aeecd # HDR10
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - b974a6cd08c1066250f1f177d7aa1225 # HDR10+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 9364dd386c9b4a1100dde8264690add7 # HLG
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 08d6d8834ad9ec87b1dc7ec8148e7a1f # PQ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # HQ Release Groups
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 3a3ff47579026e76d6504ebea39390de # Remux Tier 01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 9f98181fe5a3fbeb0cc29340da2a468a # Remux Tier 02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 8baaf0b3142bf4d94c42a724f034e27a # Remux Tier 03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 403816d65392c79236dcb6dd591aeda4 # WEB Tier 02
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - c20f169ef63c5f40c2def54abaf4438e # WEB Tier 01
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - af94e0fe497124d1f9ce732069ec8c3b # WEB Tier 03
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Movie Versions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - eca37840c13c6ef2dd0262b141a5482f # 4K Remaster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e0c07d59beb37348e975a930d5e50319 # Criterion Collection
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 0f12c086e289cf966fa5948eac571f44 # Hybrid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 9f6cbff8cfe4ebbc1bde14c7b7bec0de # IMAX Enhanced
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - eecf3a857724171f968a66cb5719e152 # IMAX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 570bc9ebecd92723d2d21500f4be314c # Remaster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 957d0f44b592285f26449575e8b1167e # Special Edition
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e9001909a4c88013a359d0b9920d7bea # Theatrical Cut
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 9d27d9d2181838f76dee150882bdc58c # Masters of Cinema
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 09d9dd29a0fc958f9796e65c2a8864b4 # Open Matte
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - db9b4c4b53d312a3ca5f1378f6440fc9 # Vinegar Syndrome
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Unwanted
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - cae4ca30163749b891686f95532519bd # AV1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - ed38b889b31be83fda192888e2286d83 # BR-DISK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e6886871085226c3da1830830146846c # Generated Dynamic HDR
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 90a6f9a284dff5103f6346090e6280c8 # LQ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e204b80c87be9497a8a6eaff48f72905 # LQ (Release Title)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 712d74cd88bceb883ee32f773656b1f5 # Sing-Along Versions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - b8cd450cbfa689c0259a01d9e29ba3d6 # 3D
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - dc98083864ea246d05a42df0d05f81cc # x265 (HD)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - bfd8eb01832d646a0a89c4deb46f8564 # Upscaled
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 0a3f082873eb454bde444150b70253cc # Extras
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Misc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - b6832f586342ef70d9c128d40c07b872 # Bad Dual Groups
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - ae9b7c9ebde1f3bd336a8cbd1ec4c5e5 # No-RlsGroup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 5c44f52a8714fdd79bb4d98e2673be1f # Retags
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 182fa1c42a2468f8488e6dcf75a81b81 # Internal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - c465ccc73923871b3eb1802042331306 # Line/Mic Dubbed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e7718d7a3ce595f289bfee26adc178f5 # Repack/Proper
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - ae43b294509409a6a13919dedd4764c4 # Repack2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 5caaaa1c08c1742aa4342d8c4cc463f2 # Repack3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 2899d84dc9372de3408e6d8cc18e9666 # x264
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 0d91270a7255a1e388fa85e959f359d8 # FreeLeech
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  # Streaming Services
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - b3b3a6ac74ecbd56bcdbefa4799fb9df # AMZN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 40e9380490e748672c2522eaaeb692f7 # ATVP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 84272245b2988854bfb76a16e60baea5 # DSNP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 509e5f41146e278f9eab1ddaceb34515 # HBO
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 5763d1b0ce84aff3b21038eea8e9b8ad # HMAX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 526d445d4c16214309f0fd2b3be18a89 # Hulu
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e0ec9672be6cac914ffad34a6b077209 # iT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 6a061313d22e51e0f25b7cd4dc065233 # MAX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - 170b1d363bd8516fbf3a3eb05d4faff6 # NF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - c9fd353f8f5f1baf56dc601c4cb29920 # PCOK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - e36a0ba1bc902b26ee40818a1d59b8bd # PMTP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - c2863d2a50c9acad1fb50e53ece60817 # STAN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              assign_scores_to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                - name: Remux + WEB 1080p</span>
</span></span></code></pre></div><p>The idea is to keep the main tasks file as streamlined as possible.</p>
<pre tabindex="0"><code>
***

## Roles/Templates

***

As the name suggests, the roles templates folder is where I keep all the files that will be templated during the play.

***

### Configs

***

Most roles will include at least one config file to be templated during the play. 

I find templating more powerful than simply copying, as a change in a variable&#39;s value will apply to the config template referencing it, negating the need to edit config files individually. 

**Example:**

```yaml

  ## Doplarr&#39;s config (config.edn.j2)

{
 :radarr/url &#34;http://{{ radarr_name }}:{{ radarr_ports_cont }}&#34;
 :radarr/api &#34;{{ radarr_api }}&#34;
 :radarr/quality-profile &#34;{{ radarr_quality_profile }}&#34;
 :radarr/rootfolder &#34;{{ radarr_root_folder }}&#34;
 :sonarr/url &#34;http://{{ sonarr_name }}:{{ sonarr_ports_cont }}&#34;
 :sonarr/api &#34;{{ sonarr_api }}&#34;
 :sonarr/quality-profile &#34;{{ sonarr_quality_profile }}&#34;
 :sonarr/rootfolder &#34;{{ sonarr_root_folder }}&#34;
 :sonarr/season-folders true
 :partial-seasons true
 :discord/token &#34;{{ doplarr_token }}&#34;
 :discord/max-results 25
 :discord/requested-msg-style :plain
 :log-level :trace
 }
</code></pre><hr>
<h3 id="compose">Compose<a href="#compose" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<hr>
<p>Each role will also have a docker compose file, containing the roles docker services.</p>
<p><strong>Docker Compose</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.9&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  {{ <span style="color:#f92672">gluetun_name }}</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: {{ <span style="color:#ae81ff">gluetun_name }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">gluetun_image_repo }}:{{ gluetun_image_tag }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">network_overlay }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">devices</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/dev/net/tun:/dev/net/tun</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cap_add</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">NET_ADMIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PUID</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PGID</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TZ</span>: <span style="color:#e6db74">&#39;{{ timezone }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">## And various other gluetun env...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">jd2_ports_host }}:{{ jd2_ports_cont }}/tcp</span>
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">searxng_ports_host }}:{{ searxng_ports_cont }}/tcp</span>
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">librewolf_ports_http_host }}:{{ librewolf_ports_http_cont }}/tcp</span>
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">librewolf_ports_https_host }}:{{ librewolf_ports_https_cont }}/tcp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">gluetun_location }}:/gluetun</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  {{ <span style="color:#f92672">jd2_name }}</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: {{ <span style="color:#ae81ff">jd2_name }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">gluetun_name }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">jd2_image_repo }}:{{ jd2_image_tag }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">network_mode</span>: <span style="color:#e6db74">&#39;service:{{ gluetun_name }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">USER_ID</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">GROUP_ID</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TZ</span>: <span style="color:#e6db74">&#39;{{ timezone }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">jd2_location }}:/config</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">bind</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">source</span>: <span style="color:#ae81ff">/mnt</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target</span>: <span style="color:#ae81ff">/output</span>
</span></span></code></pre></div><p><strong>Docker Swarm</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.9&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  {{ <span style="color:#f92672">adguard_defaults_name }}</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">adguard_defaults_image_repo }}:{{ adguard_defaults_image_tag }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - {{ <span style="color:#ae81ff">network_overlay }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PUID</span>: <span style="color:#e6db74">&#39;{{ puid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">PGID</span>: <span style="color:#e6db74">&#39;{{ pgid }}&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">TZ</span>: <span style="color:#e6db74">&#39;{{ timezone }}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_cont }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">published</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_host }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">tcp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_dns_cont }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">published</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_dns_host }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">tcp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">target</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_dns_cont }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">published</span>: {{ <span style="color:#ae81ff">adguard_defaults_ports_dns_host }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">udp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">ingress</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">bind</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">source</span>: {{ <span style="color:#ae81ff">adguard_defaults_location }}/work</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target</span>: <span style="color:#ae81ff">/opt/adguardhome/work</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">bind</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">source</span>: {{ <span style="color:#ae81ff">adguard_defaults_location }}/conf</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target</span>: <span style="color:#ae81ff">/opt/adguardhome/conf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">deploy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">replicated</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">placement</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">constraints</span>: [<span style="color:#ae81ff">node.labels.ansible_host == pvr]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>: {{ <span style="color:#ae81ff">adguard_defaults_labels }}</span>
</span></span></code></pre></div><p>In my case, I prefer letting Ansible docker modules handle networks / secrets / volumes, so they&rsquo;re listed as external at the bottom of the compose file, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  {{ <span style="color:#f92672">network_overlay }}</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">secrets</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">unifi_user_secret</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">unifi_pass_secret</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">unifi_root_pass_secret</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  {{ <span style="color:#f92672">media_volume }}</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div>
      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
